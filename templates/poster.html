{% extends "base.html" %}

{% block head %}
<style>
	#map {
		height: 100%;
		width: 100%;
		float: left;
		border: 0px;
	}
	#sidebar {
		height: 100%;
		width: 20%;
		float: right;
		padding: 10px;
		box-sizing: border-box;
		background-color: #f1f1f1;
		display: none;
	}
	html, body {
		height: 100%;
		margin: 0;
		padding: 0;
	}
</style>
{% endblock %}
{% block content %}

<div id="map"></div>
<div id="sidebar">
	<h3>Location Details</h3>
	<p id="locationInfo"></p>
	<button onclick="confirmLocation()">Confirm Location</button>
</div>
<script>
	let currentMarker = null;

	function initMap() {
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
				var pos = {
					lat: position.coords.latitude,
					lng: position.coords.longitude
				};

				var map = new google.maps.Map(document.getElementById('map'), {
					center: pos,
					zoom: 15
				});

				map.addListener('click', function(e) {
					placeMarker(e.latLng, map);
				});

			}, function() {
				handleLocationError(true, map.getCenter());
			});
		} else {
			handleLocationError(false, map.getCenter());
		}
	}

	function placeMarker(location, map) {
		if (currentMarker) {
			currentMarker.setMap(null);
		}
		currentMarker = new google.maps.Marker({
			position: location,
			map: map
		});

		documentLocation(location);
		updateSidebar(location);
	}

	function documentLocation(location) {
		console.log(`Latitude: ${location.lat()}, Longitude: ${location.lng()}`);
	}

	function updateSidebar(location) {
		document.getElementById('locationInfo').textContent = `Latitude: ${location.lat()}, Longitude: ${location.lng()}`;
		document.getElementById('sidebar').style.display = 'block';
		document.getElementById('map').style.width = '80%';
	}

	function confirmLocation() {
		console.log('Location confirmed:', currentMarker.getPosition().toString());
		// database storage here
		alert('Location confirmed!');
	}

	function handleLocationError(browserHasGeolocation, pos) {
		console.error(browserHasGeolocation ?
			'Error: The Geolocation service failed.' :
			'Error: Your browser doesn\'t support geolocation.');
	}
</script>
<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCuys5rRtnQNo3_YUCqb6g6vOhigb1J53s&callback=initMap">
</script>
{% endblock %}
